<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš½ Porra Mundial 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
        }
        /* Estilos especÃ­ficos para la tabla y cards */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .match-card {
            transition: all 0.3s ease-in-out;
        }
        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col">
        <header class="bg-blue-900 text-white shadow-lg sticky top-0 z-20">
            <div class="max-w-7xl mx-auto p-4 flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl font-extrabold flex items-center mb-3 md:mb-0">
                    âš½ Porra Mundial 2026
                </h1>
                <nav class="flex space-x-3 text-sm font-semibold">
                    <button onclick="changeView('clasificacion')" id="nav-clasificacion" class="nav-item py-2 px-4 rounded-lg transition duration-300 bg-yellow-500 text-blue-900 font-bold shadow-md">ClasificaciÃ³n</button>
                    <button onclick="changeView('partidos')" id="nav-partidos" class="nav-item py-2 px-4 rounded-lg transition duration-300 text-gray-200 hover:bg-blue-700">Partidos</button>
                </nav>
            </div>
        </header>

        <div class="max-w-7xl mx-auto w-full px-4 md:px-8 py-3 bg-white shadow-inner flex justify-center">
            <button
                onclick="handleSimulateResults()"
                class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm"
            >
                ðŸš¨ Simular Resultados de Partidos NO Jugados ðŸš¨
            </button>
        </div>

        <main id="main-content" class="flex-grow max-w-7xl mx-auto w-full p-4 md:p-8">
            <div id="view-container">
                <div class="text-center p-10 text-xl text-blue-600">Cargando aplicaciÃ³n...</div>
            </div>
        </main>

        <footer class="bg-gray-800 text-white text-center p-4 mt-8">
            <p class="text-sm">Hecho con HTML, JavaScript y Firestore. ID: <span id="app-id">Cargando...</span></p>
            <p id="user-id-display" class="text-xs mt-1 text-gray-400">Tu ID de Participante: </p>
        </footer>
    </div>

    <div id="message-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl text-center max-w-sm">
            <p id="modal-message-text" class="text-gray-800 font-semibold mb-4"></p>
            <button onclick="closeMessageModal()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                Entendido
            </button>
        </div>
    </div>

    <script type="module">
        // Importaciones de Firebase (mÃ³dulos ES)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, setDoc, updateDoc, writeBatch, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // 1. CONFIGURACIÃ“N GLOBAL Y VARIABLES
        // =================================================================

        // Variables globales (acceso desde la ventana para funciones fuera del module)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        window.currentView = 'clasificacion';
        
        window.participants = [];
        window.matches = [];
        window.allPronostics = {}; // Mapa: { matchId_userId: { predictionA, predictionB, userId } }
        
        const LOCKOUT_DATE = new Date('2026-06-11T23:59:59').getTime();
        const POINTS = { EXACT_SCORE: 5, CORRECT_OUTCOME: 2 };

        // ConfiguraciÃ³n de la aplicaciÃ³n (proporcionada por el entorno o por defecto)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-porra-app';
        document.getElementById('app-id').textContent = appId;
        
        // ConfiguraciÃ³n de logs de Firebase (opcional, para depuraciÃ³n)
        // setLogLevel('Debug');

        // =================================================================
        // 2. UTILIDADES DE FIREBASE Y PUNTUACIÃ“N
        // =================================================================

        const getPublicCollectionPath = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;
        const getPrivatePronosticDocRef = (userId, matchId) => doc(db, `/artifacts/${appId}/users/${userId}/pronostics/match_${matchId}`);
        const getParticipantDocRef = (userId) => doc(db, getPublicCollectionPath('participants'), userId);
        const getMatchDocRef = (matchId) => doc(db, getPublicCollectionPath('matches'), matchId);

        window.calculatePoints = (actualA, actualB, predA, predB) => {
            if (actualA === null || actualB === null) return 0;

            const actualResult = Math.sign(actualA - actualB);
            const predictedResult = Math.sign(predA - predB);

            if (actualA === predA && actualB === predB) {
                return POINTS.EXACT_SCORE;
            }

            if (actualResult === predictedResult) {
                return POINTS.CORRECT_OUTCOME;
            }
            return 0;
        };

        // =================================================================
        // 3. INICIALIZACIÃ“N DE FIREBASE
        // =================================================================

        const initializeFirebase = () => {
            try {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-id-display').textContent = `Tu ID de Participante: ${user.uid}`;
                        
                        // Crear o actualizar perfil del participante
                        await setDoc(getParticipantDocRef(user.uid), {
                            name: `Participante ${user.uid.substring(0, 4)}`,
                            points: 0,
                            id: user.uid
                        }, { merge: true });
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(window